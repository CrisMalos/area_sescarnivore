<!DOCTYPE html>
<html>
<head>
  <title>Draw on Map</title>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0">

  <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />
  <link rel="stylesheet" href="https://unpkg.com/leaflet-draw/dist/leaflet.draw.css" />
  <script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
  <script src="https://unpkg.com/leaflet-draw/dist/leaflet.draw.js"></script>

  <style>
    html, body { height:100%; margin:0; }
    #map { height:100%; width:100%; }
    .toolbar {
      position: absolute; z-index: 1000; top: 10px; right: 10px;
      background: white; padding: 8px; border-radius: 8px;
      box-shadow: 0 2px 10px rgba(0,0,0,0.15); font-family: system-ui, sans-serif;
    }
    .toolbar button, .toolbar input[type="file"] {
      margin: 4px 0; width: 100%;
    }
    .note {
      position:absolute; z-index:1000; bottom:10px; left:10px;
      background:white; padding:6px 8px; border-radius:6px; font-size:12px;
      box-shadow: 0 2px 6px rgba(0,0,0,0.1);
    }
  </style>
</head>
<body>
  <div id="map"></div>

  <div class="toolbar">
    <button id="btn-export">Download GeoJSON</button>
    <input id="file-input" type="file" accept=".geojson,.json">
    <button id="btn-clear">Clear</button>
  </div>
  <div class="note">Tip: Circles don’t keep radius in GeoJSON. Prefer polygons/markers.</div>

  <script>
    // 1) Map
    const map = L.map('map').setView([44.4268, 26.1025], 11); // Bucharest
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
      maxZoom: 19, attribution: '&copy; OpenStreetMap contributors'
    }).addTo(map);

    // 2) Draw layer + controls (disable circle to avoid export issues)
    const drawnItems = new L.FeatureGroup().addTo(map);
    const drawControl = new L.Control.Draw({
      edit: { featureGroup: drawnItems },
      draw: {
        polygon: true,
        polyline: true,
        rectangle: true,
        circle: false,      // disable because radius isn’t in GeoJSON
        circlemarker: false,
        marker: true
      }
    });
    map.addControl(drawControl);

    // 3) Add features on draw
    map.on(L.Draw.Event.CREATED, (e) => {
      drawnItems.addLayer(e.layer);
      saveLocal(); // autosave
      console.log(JSON.stringify(e.layer.toGeoJSON()));
    });
    map.on(L.Draw.Event.EDITED, saveLocal);
    map.on(L.Draw.Event.DELETED, saveLocal);

    // 4) Local autosave
    const LS_KEY = 'drawn-geojson-v1';
    function saveLocal() {
      localStorage.setItem(LS_KEY, JSON.stringify(drawnItems.toGeoJSON()));
    }
    // Load saved shapes on startup
    (function loadLocal(){
      const saved = localStorage.getItem(LS_KEY);
      if (!saved) return;
      try { L.geoJSON(JSON.parse(saved)).eachLayer(l => drawnItems.addLayer(l)); }
      catch(_) {}
    })();

    // 5) Download GeoJSON
document.getElementById('btn-export').onclick = () => {
  const data = drawnItems.toGeoJSON();
  const blob = new Blob([JSON.stringify(data, null, 2)], { type: "application/json" });
  const url = URL.createObjectURL(blob);

  // Ask the user for a filename
  let filename = prompt("Enter file name (without extension):", "my-geometries");
  if (!filename) return; // user cancelled
  if (!filename.endsWith('.geojson')) filename += '.geojson';

  const a = Object.assign(document.createElement('a'), {
    href: url,
    download: filename
  });
  document.body.appendChild(a);
  a.click();
  a.remove();
  URL.revokeObjectURL(url);
};

    // 6) Import GeoJSON
    document.getElementById('file-input').onchange = (e) => {
      const file = e.target.files[0];
      if (!file) return;
      const reader = new FileReader();
      reader.onload = () => {
        try {
          const geojson = JSON.parse(reader.result);
          L.geoJSON(geojson).eachLayer(l => drawnItems.addLayer(l));
          saveLocal();
        } catch (err) { alert('Invalid GeoJSON'); }
      };
      reader.readAsText(file);
      e.target.value = ''; // reset input
    };

    // 7) Clear
    document.getElementById('btn-clear').onclick = () => {
      drawnItems.clearLayers();
      saveLocal();
    };
  </script>
</body>
</html>
